<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.cdnfonts.com/css/turnpike" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">       
    <title>signals</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.6;
        }

        /* Navigation Bar */
        nav {
            background-color: rgba(0,0,0,0.90);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: 400;
            color: #ffffff;
            font-family:'Turnpike', sans-serif;
                                                
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #ffffff;
            text-decoration: none;
            transition: color 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #22c55e;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Section Headers */
        section {
            margin-bottom: 3rem;
        }

        section h2 {
            font-size: 12px;
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: none;
            text-align: left;
        }

        /* Grid Layout */
        .feed-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        /* Widget Cards */
        .widget {
            background-color: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
        }

        .widget:hover {
            transform: translateY(-4px);
            border-color: #22c55e;
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #ffffff;
            text-decoration: none;
            display: block;
        }

        .widget-title:hover {
            color: #22c55e;
        }

        .widget-meta {
            color: #888888;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .widget-description {
            color: #cccccc;
            font-size: 0.95rem;
            flex-grow: 1;
            margin-bottom: 1rem;
        }

        .widget-link {
            color: #22c55e;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            align-self: flex-start;
        }

        .widget-link:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: #888888;
            font-size: 1.2rem;
        }
        
        .loading-message {
            padding: 3rem;
        }

        /* Error State */
        .error {
            background-color: #331111;
            border: 1px solid #663333;
            border-radius: 8px;
            padding: 1.5rem;
            color: #ff6666;
            text-align: center;
        }

        /* Last Updated */
        .last-updated {
            text-align: center;
            color: #666666;
            font-size: 0.875rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        /* Source Info */
        .source-info {
            text-align: center;
            color: #666666;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        /* Top Row Containers */
        .top-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .top-container {
            background-color: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s;
        }

        .top-container:hover {
            transform: translateY(-4px);
            border-color: #22c55e;
        }

        .top-container-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #ffffff;
        }

        .top-container-subtitle {
            font-size: 0.95rem;
            color: #888888;
            margin-bottom: 1rem;
        }

        .top-container-description {
            font-size: 0.95rem;
            color: #cccccc;
            line-height: 1.6;
        }

        /* Footer */
        footer {
            background-color: rgba(0,0,0,0.90);
            padding: 1.5rem 2rem;
            margin-top: 0.75rem;
        }

        .footer-links {
            display: flex;
            justify-content: flex-end;
            gap: 2rem;
            list-style: none;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #333333;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .footer-links a:hover {
            color: #22c55e;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .feed-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .top-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .feed-grid {
                grid-template-columns: 1fr;
            }

            .top-row {
                grid-template-columns: 1fr;
            }

            nav {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .footer-links {
                justify-content: center;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-title">Signals</div>
        <ul class="nav-links">
            <li><a href="#feed">Feed</a></li>
            <li><a href="#about">About</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="top-row">
            <div class="top-container">
                <div class="top-container-title">Title Placeholder</div>
                <div class="top-container-subtitle">Subtitle Placeholder</div>
                <div class="top-container-description">Description placeholder text goes here. This section can contain additional information about the content or feature.</div>
            </div>
            <div class="top-container" id="cyberwire-box">
                <div class="top-container-title">Title Placeholder</div>
                <div class="top-container-subtitle">Subtitle Placeholder</div>
                <div class="top-container-description">Description placeholder text goes here. This section can contain additional information about the content or feature.</div>
            </div>
            <div class="top-container">
                <div class="top-container-title">Title Placeholder</div>
                <div class="top-container-subtitle">Subtitle Placeholder</div>
                <div class="top-container-description">Description placeholder text goes here. This section can contain additional information about the content or feature.</div>
            </div>
        </div>

        <section id="feed">
            <div id="feed-container">
                <div class="loading loading-message">Loading feed...</div>
            </div>
            <p style="color: #cccccc; text-align:center;">The feed is automatically updated twice daily.</p>
            <div id="last-updated" class="last-updated"></div>
        </section>
    </div>

    <script>
        async function loadFeed() {
            const feedContainer = document.getElementById('feed-container');
            const lastUpdatedElement = document.getElementById('last-updated');

            try {
                // Try to load feed data from the JSON file generated by GitHub Actions
                const response = await fetch('feed-data.json');
                
                if (!response.ok) {
                    throw new Error('Feed data not available yet');
                }

                const data = await response.json();
                
                // Handle new multi-feed structure
                const feeds = data.feeds || [];
                
                // Backward compatibility: if old format (data.items), convert to new format
                if (!feeds.length && data.items && data.items.length > 0) {
                    feeds.push({
                        id: 'legacy',
                        source: data.source || 'Feed',
                        items: data.items
                    });
                }
                
                if (feeds.length === 0) {
                    feedContainer.innerHTML = '<div class="error">No feed items available</div>';
                    return;
                }

                // Populate CyberWire box (2nd box in top row)
                const cyberWireFeed = feeds.find(feed => feed.id === 'cyberwire');
                if (cyberWireFeed && cyberWireFeed.items && cyberWireFeed.items.length > 0) {
                    const latestItem = cyberWireFeed.items[0];
                    const cyberWireBox = document.getElementById('cyberwire-box');
                    
                    if (cyberWireBox && latestItem.link) {
                        // Create clickable title link
                        const titleElement = cyberWireBox.querySelector('.top-container-title');
                        titleElement.innerHTML = '';
                        const titleLink = document.createElement('a');
                        titleLink.href = latestItem.link;
                        titleLink.target = '_blank';
                        titleLink.rel = 'noopener noreferrer';
                        // Clean title by removing common prefixes
                        let cleanTitle = latestItem.title || 'Untitled';
                        cleanTitle = cleanTitle.replace(/^(Latest CyberWire News:\s*|CyberWire:\s*|The CyberWire:\s*)/i, '');
                        titleLink.textContent = cleanTitle;
                        titleLink.style.color = '#ffffff';
                        titleLink.style.textDecoration = 'none';
                        titleLink.style.transition = 'color 0.3s';
                        titleLink.onmouseover = function() { this.style.color = '#22c55e'; };
                        titleLink.onmouseout = function() { this.style.color = '#ffffff'; };
                        titleElement.appendChild(titleLink);
                        
                        // Set subtitle with date
                        const subtitleElement = cyberWireBox.querySelector('.top-container-subtitle');
                        let dateString = 'The CyberWire';
                        const dateValue = latestItem.published || latestItem.pubDate;
                        if (dateValue) {
                            try {
                                const pubDate = new Date(dateValue);
                                if (!isNaN(pubDate.getTime())) {
                                    dateString = `The CyberWire - ${pubDate.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        year: 'numeric'
                                    })}`;
                                }
                            } catch (e) {
                                console.warn('Failed to parse date for CyberWire:', e);
                            }
                        }
                        subtitleElement.textContent = dateString;
                        
                        // Set description with truncated summary
                        const descElement = cyberWireBox.querySelector('.top-container-description');
                        let textContent = '';
                        const descValue = latestItem.summary || latestItem.description;
                        if (descValue) {
                            try {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(descValue, 'text/html');
                                textContent = doc.body.textContent || doc.body.innerText || '';
                            } catch (e) {
                                textContent = descValue;
                            }
                        }
                        textContent = textContent.trim();
                        const truncated = textContent.substring(0, 200);
                        descElement.textContent = truncated + (textContent.length > 200 ? '...' : '');
                    }
                }

                // Clear container
                feedContainer.innerHTML = '';

                // Render each feed as a separate section
                feeds.forEach((feed, feedIndex) => {
                    if (!feed.items || feed.items.length === 0) {
                        console.warn(`Feed ${feedIndex} has no items, skipping`);
                        return;
                    }

                    // Create feed section with title
                    const feedSection = document.createElement('div');
                    feedSection.className = 'feed-section';
                    feedSection.style.marginBottom = '3rem';

                    const feedTitle = document.createElement('h2');
                    feedTitle.textContent = feed.source || 'Feed';
                    feedTitle.style.fontSize = '12px';
                    feedTitle.style.marginBottom = '2rem';
                    feedTitle.style.paddingBottom = '0.5rem';
                    feedTitle.style.borderBottom = '2px solid #333333';
                    feedSection.appendChild(feedTitle);

                    // Create grid with widgets for this feed
                    const grid = document.createElement('div');
                    grid.className = 'feed-grid';

                    feed.items.slice(0, 9).forEach((item, index) => {
                        // Validate item has required fields
                        if (!item || !item.link) {
                            console.warn(`Feed ${feedIndex}, item ${index}: missing required fields`);
                            return;
                        }
                        
                        const widget = document.createElement('div');
                        widget.className = 'widget';

                        const title = document.createElement('a');
                        title.className = 'widget-title';
                        title.href = item.link;
                        title.target = '_blank';
                        title.rel = 'noopener noreferrer';
                        // Ensure title is a string and not empty
                        title.textContent = item.title || 'Untitled';

                        const meta = document.createElement('div');
                        meta.className = 'widget-meta';
                        // Safely parse and format date (handle both 'pubDate' and 'published')
                        let dateString = 'Date unknown';
                        const dateValue = item.published || item.pubDate;
                        if (dateValue) {
                            try {
                                const pubDate = new Date(dateValue);
                                // Check if date is valid
                                if (!isNaN(pubDate.getTime())) {
                                    dateString = pubDate.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                } else {
                                    // If date parsing fails, show raw date string
                                    dateString = dateValue;
                                }
                            } catch (e) {
                                console.warn('Failed to parse date:', dateValue, e);
                                dateString = dateValue || 'Date unknown';
                            }
                        }
                        meta.textContent = dateString;

                        const description = document.createElement('div');
                        description.className = 'widget-description';
                        // Safely extract and sanitize text from description/summary
                        let textContent = '';
                        const descValue = item.summary || item.description;
                        if (descValue) {
                            try {
                                // Use DOMParser to safely parse HTML and extract text content
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(descValue, 'text/html');
                                // Get text content, which automatically strips HTML tags and scripts
                                textContent = doc.body.textContent || doc.body.innerText || '';
                            } catch (e) {
                                // Fallback: use the raw description if parsing fails
                                console.warn('Failed to parse description:', e);
                                textContent = descValue;
                            }
                        }
                        // Trim whitespace and truncate
                        textContent = textContent.trim();
                        const truncated = textContent.substring(0, 150);
                        // Use textContent (not innerHTML) to prevent XSS
                        description.textContent = truncated + (textContent.length > 150 ? '...' : '');

                        const link = document.createElement('a');
                        link.className = 'widget-link';
                        link.href = item.link;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.textContent = 'Read more â†’';

                        widget.appendChild(title);
                        widget.appendChild(meta);
                        widget.appendChild(description);
                        widget.appendChild(link);
                        grid.appendChild(widget);
                    });

                    feedSection.appendChild(grid);
                    feedContainer.appendChild(feedSection);
                });

                // Update last updated time
                if (data.fetched_at || data.lastUpdated) {
                    try {
                        const updateDate = new Date(data.fetched_at || data.lastUpdated);
                        if (!isNaN(updateDate.getTime())) {
                            lastUpdatedElement.textContent = `Last updated: ${updateDate.toLocaleString()}`;
                        }
                    } catch (e) {
                        console.warn('Failed to parse lastUpdated date:', e);
                    }
                }

            } catch (error) {
                console.error('Error loading feed:', error);
                feedContainer.innerHTML = `
                    <div class="error">
                        <p>Unable to load feed data. The feed will be available after the first scheduled update.</p>
                    </div>
                `;
            }
        }

        // Load feed when page loads
        document.addEventListener('DOMContentLoaded', loadFeed);
    </script>

    <footer>
        <ul class="footer-links">
            <li><a href="https://www.pizzint.watch/" target="_blank" rel="noopener noreferrer">Bilateral Tension Monitor</a></li>
            <li><a href="https://h1dr4.dev/" target="_blank" rel="noopener noreferrer">GDELT ODIN AI</a></li>
            <li><a href="https://worldtensionwatch.com/analytics" target="_blank" rel="noopener noreferrer">Tension Watch</a></li>
            <li><a href="https://threatmap.bitdefender.com/" target="_blank" rel="noopener noreferrer">Attack Map</a></li>
            <li><a href="https://blackkite.com/data-breaches-caused-by-third-parties" target="_blank" rel="noopener noreferrer">SaaS BREACH DB</a></li>
        </ul>
    </footer>
</body>
</html>
