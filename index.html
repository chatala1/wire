<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.cdnfonts.com/css/turnpike" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">       
    <title>signals</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.6;
        }

        /* Navigation Bar */
        nav {
            background-color: rgba(0,0,0,0.90);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-title {
            font-size: 1rem;
            font-weight: 400;
            color: #ffffff;
            font-family:'Turnpike', sans-serif;
                                                
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #ffffff;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-links a:hover {
            color: #22c55e;
        }

        /* Tools Dropdown */
        .tools-container {
            position: relative;
        }

        #tools-toggle {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0;
            font-family: inherit;
        }

        #tools-toggle:hover {
            color: #22c55e;
        }

        #tools-toggle:focus {
            outline: 2px solid #22c55e;
            outline-offset: 2px;
        }

        #tools-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            min-width: 250px;
            display: none;
            z-index: 1000;
        }

        #tools-menu.show {
            display: block;
        }

        #tools-menu ul {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
        }

        #tools-menu li {
            margin: 0;
        }

        #tools-menu a {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #ffffff;
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
        }

        #tools-menu a:hover {
            background-color: #1a1a1a;
            color: #22c55e;
        }

        #tools-menu a:focus {
            outline: 2px solid #22c55e;
            outline-offset: -2px;
            background-color: #1a1a1a;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Section Headers */
        section {
            margin-bottom: 3rem;
        }

        section h2 {
            font-size: 12px;
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: none;
            text-align: left;
        }

        /* Grid Layout */
        .feed-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        /* Widget Cards */
        .widget {
            background-color: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
        }

        .widget:hover {
            transform: translateY(-4px);
            border-color: #22c55e;
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #ffffff;
            text-decoration: none;
            display: block;
        }

        .widget-title:hover {
            color: #22c55e;
        }

        .widget-meta {
            color: #888888;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .widget-link {
            color: #22c55e;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            align-self: flex-start;
        }

        .widget-link:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: #888888;
            font-size: 1.2rem;
        }
        
        .loading-message {
            padding: 3rem;
        }

        /* Error State */
        .error {
            background-color: #331111;
            border: 1px solid #663333;
            border-radius: 8px;
            padding: 1.5rem;
            color: #ff6666;
            text-align: center;
        }

        /* Last Updated */
        .last-updated {
            text-align: center;
            color: #666666;
            font-size: 0.875rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        /* Source Info */
        .source-info {
            text-align: center;
            color: #666666;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        /* Footer */
        footer {
            background-color: rgba(0,0,0,0.90);
            padding: 1.5rem 2rem;
            margin-top: 0.75rem;
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .feed-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .feed-grid {
                grid-template-columns: 1fr;
            }

            nav {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            #tools-menu {
                left: 0;
                right: auto;
                min-width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-title">Signals</div>
        <ul class="nav-links">
            <li><a href="#feed">News</a></li>
            <li><a href="#analysis">Analysis</a></li>
            <li class="tools-container">
                <button id="tools-toggle" aria-haspopup="true" aria-expanded="false">Tools ▾</button>
                <div id="tools-menu" role="menu" aria-label="Tools menu">
                    <ul>
                        <li><a href="https://www.pizzint.watch/" target="_blank" rel="noopener noreferrer" role="menuitem">Bilateral Tension Monitor</a></li>
                        <li><a href="https://h1dr4.dev/" target="_blank" rel="noopener noreferrer" role="menuitem">GDELT ODIN AI</a></li>
                        <li><a href="https://worldtensionwatch.com/analytics" target="_blank" rel="noopener noreferrer" role="menuitem">Tension Watch</a></li>
                        <li><a href="https://threatmap.bitdefender.com/" target="_blank" rel="noopener noreferrer" role="menuitem">Attack Map</a></li>
                        <li><a href="https://blackkite.com/data-breaches-caused-by-third-parties" target="_blank" rel="noopener noreferrer" role="menuitem">SaaS BREACH DB</a></li>
                        <li><a href="https://ipapi.is/most-abusive-asn.html" target="_blank" rel="noopener noreferrer" role="menuitem">ASN Blacklist</a></li>
                        <li><a href="https://viz.greynoise.io" target="_blank" rel="noopener noreferrer" role="menuitem">Greynoise</a></li>
                    </ul>
                </div>
            </li>
        </ul>
    </nav>

    <div class="container">
        <section id="feed">
            <div id="feed-container">
                <div class="loading loading-message">Loading feed...</div>
            </div>
            <p style="color: #cccccc; text-align:center;"></p>
            <div id="last-updated" class="last-updated"></div>
        </section>
    </div>

    <script>
        async function loadFeed() {
            const feedContainer = document.getElementById('feed-container');
            const lastUpdatedElement = document.getElementById('last-updated');

            try {
                // Try to load feed data from the JSON file generated by GitHub Actions
                // Add cache-busting to ensure fresh data on each load
                const response = await fetch(`feed-data.json?t=${new Date().getTime()}`, {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error('Feed data not available yet');
                }

                const data = await response.json();
                
                // Handle feed structure
                const feeds = data.feeds || [];
                
                // Backward compatibility: if old format (data.items), convert to new format
                if (!feeds.length && data.items && data.items.length > 0) {
                    feeds.push({
                        id: 'legacy',
                        source: data.source || 'Feed',
                        items: data.items
                    });
                }
                
                if (feeds.length === 0) {
                    feedContainer.innerHTML = '<div class="error">No feed items available</div>';
                    return;
                }

                // Clear container
                feedContainer.innerHTML = '';

                // Get The Record feed (should be the only one)
                const recordFeed = feeds[0];
                
                if (!recordFeed || !recordFeed.items || recordFeed.items.length === 0) {
                    feedContainer.innerHTML = '<div class="error">No feed items available</div>';
                    return;
                }

                // Create grid with widgets for The Record feed (9 items)
                const grid = document.createElement('div');
                grid.className = 'feed-grid';

                recordFeed.items.slice(0, 9).forEach((item, index) => {
                        // Validate item has required fields
                        if (!item || !item.link) {
                            console.warn(`Feed ${feedIndex}, item ${index}: missing required fields`);
                            return;
                        }
                        
                        const widget = document.createElement('div');
                        widget.className = 'widget';

                        const title = document.createElement('a');
                        title.className = 'widget-title';
                        title.href = item.link;
                        title.target = '_blank';
                        title.rel = 'noopener noreferrer';
                        // Ensure title is a string and not empty
                        title.textContent = item.title || 'Untitled';

                        const meta = document.createElement('div');
                        meta.className = 'widget-meta';
                        // Safely parse and format date (handle both 'pubDate' and 'published')
                        let dateString = 'Date unknown';
                        const dateValue = item.published || item.pubDate;
                        if (dateValue) {
                            try {
                                const pubDate = new Date(dateValue);
                                // Check if date is valid
                                if (!isNaN(pubDate.getTime())) {
                                    dateString = pubDate.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                } else {
                                    // If date parsing fails, show raw date string
                                    dateString = dateValue;
                                }
                            } catch (e) {
                                console.warn('Failed to parse date:', dateValue, e);
                                dateString = dateValue || 'Date unknown';
                            }
                        }
                        meta.textContent = dateString;

                        const link = document.createElement('a');
                        link.className = 'widget-link';
                        link.href = item.link;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.textContent = 'Read more →';

                    widget.appendChild(title);
                    widget.appendChild(meta);
                    widget.appendChild(link);
                    grid.appendChild(widget);
                });

                feedContainer.appendChild(grid);

                // Update last updated time
                if (data.fetched_at || data.lastUpdated) {
                    try {
                        const updateDate = new Date(data.fetched_at || data.lastUpdated);
                        if (!isNaN(updateDate.getTime())) {
                            lastUpdatedElement.textContent = `Last updated: ${updateDate.toLocaleString()}`;
                        }
                    } catch (e) {
                        console.warn('Failed to parse lastUpdated date:', e);
                    }
                }

            } catch (error) {
                console.error('Error loading feed:', error);
                feedContainer.innerHTML = `
                    <div class="error">
                        <p>Unable to load feed data. The feed will be available after the first scheduled update.</p>
                    </div>
                `;
            }
        }

        // Load feed and initialize dropdown when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load feed
            loadFeed();
            
            // Tools dropdown functionality
            const toolsToggle = document.getElementById('tools-toggle');
            const toolsMenu = document.getElementById('tools-menu');
            const menuLinks = toolsMenu.querySelectorAll('a');

            // Toggle dropdown
            function toggleDropdown() {
                const isExpanded = toolsToggle.getAttribute('aria-expanded') === 'true';
                toolsToggle.setAttribute('aria-expanded', !isExpanded);
                toolsMenu.classList.toggle('show');
                
                // Focus first menu item when opening with keyboard
                if (!isExpanded) {
                    menuLinks[0].focus();
                }
            }

            // Close dropdown
            function closeDropdown() {
                toolsToggle.setAttribute('aria-expanded', 'false');
                toolsMenu.classList.remove('show');
            }

            // Toggle on click
            toolsToggle.addEventListener('click', function(e) {
                // Stop event propagation to prevent the document click handler from interfering
                e.stopPropagation();
                toggleDropdown();
            });

            // Close when clicking outside
            document.addEventListener('click', function(e) {
                const isClickInsideMenu = toolsMenu.contains(e.target);
                const isClickOnToggle = toolsToggle.contains(e.target);
                
                if (!isClickInsideMenu && !isClickOnToggle) {
                    closeDropdown();
                }
            });

            // Keyboard navigation
            toolsToggle.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (toolsMenu.classList.contains('show')) {
                        menuLinks[0].focus();
                    } else {
                        toggleDropdown();
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDropdown();
                    toolsToggle.focus();
                }
            });

            // Handle escape key in menu
            toolsMenu.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDropdown();
                    toolsToggle.focus();
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const currentIndex = Array.from(menuLinks).indexOf(document.activeElement);
                    if (currentIndex < menuLinks.length - 1) {
                        menuLinks[currentIndex + 1].focus();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const currentIndex = Array.from(menuLinks).indexOf(document.activeElement);
                    if (currentIndex > 0) {
                        menuLinks[currentIndex - 1].focus();
                    } else {
                        toolsToggle.focus();
                        closeDropdown();
                    }
                }
            });
        });
    </script>

    <footer>
        <!-- Footer hidden to avoid duplication of tools links -->
    </footer>
</body>
</html>
